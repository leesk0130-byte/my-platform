<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>글 수정 | 가맹점숲</title>
  <link rel="stylesheet" href="css/common.css">
</head>
<body>
  <a href="#main" class="skip-link">본문으로 건너뛰기</a>
  <header>
    <h1><a href="index.html">가맹점숲</a></h1>
    <button type="button" class="nav-toggle" aria-label="메뉴 열기" aria-expanded="false" onclick="toggleNav()"><span></span><span></span><span></span></button>
    <nav class="header-nav" id="headerNav" aria-label="메인 메뉴">
      <a href="news.html">뉴스</a>
      <a href="pg.html">PG 수수료</a>
      <a href="calculator.html">수수료 계산기</a>
      <a href="must-know.html">꼭 알아야 할 것</a>
      <a href="community.html" class="active">커뮤니티</a>
    </nav>
    <div class="header-auth" id="headerAuth">
      <span class="header-user" id="headerUser" style="display:none;"></span>
      <a href="community.html" class="btn btn-outline">목록으로</a>
      <button type="button" class="btn btn-outline" id="headerLogoutBtn" style="display:none;" onclick="if(window.app&&window.app.logout)window.app.logout();if(typeof updateHeaderAuth==='function')updateHeaderAuth();">로그아웃</button>
    </div>
  </header>

  <main id="main" class="container page-community">
    <nav class="breadcrumb" aria-label="breadcrumb"><a href="index.html">홈</a> <span class="bc-sep">/</span> <a href="community.html">커뮤니티</a> <span class="bc-sep">/</span> <strong>글 수정</strong></nav>
    <div class="hero">
      <h2>글 수정</h2>
    </div>
    <section class="section">
      <div id="edit-not-found" class="card card-content" style="display:none;">
        <p class="msg-error">글이 없거나 삭제되었습니다.</p>
        <a href="community.html" class="btn btn-primary mt-4">목록으로</a>
      </div>
      <div id="edit-no-permission" class="card card-content" style="display:none;">
        <p class="msg-error">수정 권한이 없습니다.</p>
        <p class="form-hint mt-2">작성자 본인 또는 운영자만 수정할 수 있어요.</p>
        <a href="community.html" class="btn btn-primary mt-4">목록으로</a>
      </div>
      <div id="edit-form-wrap" class="card card-content" style="display:none;">
        <form id="editForm" class="write-form" onsubmit="return false;">
          <div class="form-group">
            <label for="edit-board">게시판</label>
            <select id="edit-board">
              <option value="free">자유게시판</option>
              <option value="fee">수수료/정산</option>
              <option value="qna">질문답변</option>
              <option value="info">정보공유</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit-title">제목</label>
            <input type="text" id="edit-title" placeholder="제목을 입력하세요" required maxlength="200">
          </div>
          <div class="form-group">
            <label for="edit-body">내용</label>
            <textarea id="edit-body" placeholder="내용을 입력하세요" required></textarea>
          </div>
          <div id="edit-error" class="msg-error" style="display:none;"></div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">수정 완료</button>
            <a href="#" id="edit-cancel" class="btn btn-outline">취소</a>
          </div>
        </form>
      </div>
    </section>
  </main>

  <footer>
    <div class="footer-inner">
      <p><a href="terms.html">이용약관</a> | <a href="privacy.html">개인정보처리방침</a> | <a href="verify.html">인증 안내</a></p>
      <p>© 2025–2026 가맹점숲. 온라인 가맹점 정보 & 커뮤니티. All rights reserved.</p>
      <div class="footer-contact">
        <h4>문의하기</h4>
        <p>문의: <a href="mailto:leesk0130@naver.com?subject=가맹점숲 문의">leesk0130@naver.com</a></p>
      </div>
    </div>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="js/config.js"></script>
  <script src="js/app.js"></script>
  <script src="js/auth.js"></script>
  <script>
    function updateHeaderAuth() {
      var auth = document.getElementById('headerAuth');
      var userEl = document.getElementById('headerUser');
      var logoutBtn = document.getElementById('headerLogoutBtn');
      if (!auth) return;
      var loggedIn = window.app && window.app.isLoggedIn && window.app.isLoggedIn();
      var user = window.app && window.app.getUser && window.app.getUser();
      if (loggedIn && user && userEl) { userEl.textContent = (user.name || user.email || '회원') + '님'; userEl.style.display = 'inline'; }
      else if (userEl) userEl.style.display = 'none';
      if (logoutBtn) logoutBtn.style.display = loggedIn ? 'inline-block' : 'none';
    }
    window.addEventListener('authStateChanged', updateHeaderAuth);
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', updateHeaderAuth); else updateHeaderAuth();

    (function() {
      var params = new URLSearchParams(location.search);
      var postId = params.get('id');
      var notFoundEl = document.getElementById('edit-not-found');
      var noPermEl = document.getElementById('edit-no-permission');
      var formWrap = document.getElementById('edit-form-wrap');
      var cancelLink = document.getElementById('edit-cancel');
      if (cancelLink) cancelLink.href = 'community.html?id=' + encodeURIComponent(postId || '');

      if (!postId || !window.app) {
        if (notFoundEl) notFoundEl.style.display = 'block';
        return;
      }
      var post = window.app.getLocalPostById(postId);
      if (!post) {
        if (notFoundEl) notFoundEl.style.display = 'block';
        return;
      }
      if (!window.app.canEditPost || !window.app.canEditPost(post)) {
        if (noPermEl) noPermEl.style.display = 'block';
        return;
      }
      if (formWrap) formWrap.style.display = 'block';
      document.getElementById('edit-title').value = post.title || '';
      document.getElementById('edit-body').value = post.body || '';
      document.getElementById('edit-board').value = post.board || 'free';

      document.getElementById('editForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var title = document.getElementById('edit-title').value.trim();
        var body = document.getElementById('edit-body').value.trim();
        var board = document.getElementById('edit-board').value;
        var errEl = document.getElementById('edit-error');
        if (!title || !body) {
          errEl.textContent = '제목과 내용을 입력해 주세요.';
          errEl.style.display = 'block';
          return;
        }
        errEl.style.display = 'none';
        var submitBtn = this.querySelector('button[type="submit"]');
        if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = '저장 중...'; }
        window.app.updatePost(postId, { title: title, body: body, board: board }, function(err, updated) {
          if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = '수정 완료'; }
          if (err) {
            errEl.textContent = err;
            errEl.style.display = 'block';
            return;
          }
          location.href = 'community.html?id=' + encodeURIComponent(postId);
        });
      });
    })();
    function toggleNav() {
      var nav = document.getElementById('headerNav');
      var btn = document.querySelector('.nav-toggle');
      if (!nav || !btn) return;
      var open = nav.classList.toggle('is-open');
      btn.setAttribute('aria-expanded', open);
      btn.setAttribute('aria-label', open ? '메뉴 닫기' : '메뉴 열기');
    }
  </script>
</body>
</html>
